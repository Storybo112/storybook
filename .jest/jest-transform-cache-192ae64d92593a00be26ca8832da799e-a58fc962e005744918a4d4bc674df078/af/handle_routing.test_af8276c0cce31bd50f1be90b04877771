'use strict';

var _handle_routing = require('./handle_routing');

describe('manager.ui.config.handle_routing', function () {
  describe('changeUrl', function () {
    test('should not do anything if insidePopState=true', function () {
      _handle_routing.config.insidePopState = true;
      // This should throws an error if insidePopState = false
      (0, _handle_routing.changeUrl)(null);
      _handle_routing.config.insidePopState = false;
    });

    test('should put the correct URL and state to pushState', function (done) {
      var state = {
        selectedKind: 'kk',
        selectedStory: 'ss',
        customQueryParams: {
          customText: 'test' },

        shortcutOptions: {
          goFullScreen: false,
          showDownPanel: true,
          showLeftPanel: true,
          downPanelInRight: true },

        selectedDownPanel: 'pp' };

      var clientStore = {
        getAll: function getAll() {
          return state;
        } };

      var url = '?customText=test&selectedKind=kk&selectedStory=ss&full=0&down=1&left=1&panelRight=1&downPanel=pp';

      var pushState = {
        url: url,
        selectedKind: 'kk',
        selectedStory: 'ss',
        full: false,
        down: true,
        left: true,
        panelRight: true,
        downPanel: 'pp',
        customText: 'test' };

      var originalPushState = window.history.pushState;
      window.history.pushState = function (s, t, u) {
        expect(s).toEqual(pushState);
        expect(u).toBe(pushState.url);
        done();
      };

      (0, _handle_routing.changeUrl)(clientStore);

      window.history.pushState = originalPushState;
    });
  });

  describe('handleInitialUrl', function () {
    test('should call the correct action according to URL', function () {
      var actions = {
        api: {
          selectStory: jest.fn(),
          setQueryParams: jest.fn() },

        shortcuts: {
          setOptions: jest.fn() },

        ui: {
          selectDownPanel: jest.fn() } };


      var url = '?selectedKind=kk&selectedStory=ss&full=1&down=0&left=0&panelRight=0&downPanel=test&customText=teststring';

      var location = {
        search: url };

      window.location.search = url;
      (0, _handle_routing.handleInitialUrl)(actions, location);

      expect(actions.api.selectStory).toHaveBeenCalled();
      expect(actions.shortcuts.setOptions).toHaveBeenCalled();
      expect(actions.ui.selectDownPanel).toHaveBeenCalled();
      expect(actions.shortcuts.setOptions).toHaveBeenCalledWith({
        goFullScreen: true,
        showDownPanel: false,
        showLeftPanel: false,
        downPanelInRight: false });

      expect(actions.ui.selectDownPanel).toHaveBeenCalledWith('test');
      expect(actions.api.setQueryParams).toHaveBeenCalledWith({
        customText: 'teststring' });

    });
  });
});